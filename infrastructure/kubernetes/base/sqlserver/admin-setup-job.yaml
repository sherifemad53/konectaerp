apiVersion: batch/v1
kind: Job
metadata:
  name: sqlserver-admin-setup
  namespace: default
  labels:
    app: sqlserver-admin-setup
    component: database-admin
spec:
  ttlSecondsAfterFinished: 100
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: sqlserver-admin-setup
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-sqlserver
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for SQL Server to be ready..."
              until nc -z sqlserver 1433; do
                echo "SQL Server is unavailable - sleeping"
                sleep 2
              done
              echo "SQL Server is up - waiting 10 more seconds for full initialization"
              sleep 10
      containers:
        - name: admin-setup
          image: mcr.microsoft.com/mssql-tools
          env:
            - name: SA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sqlserver-secret
                  key: SA_PASSWORD
          command:
            - /bin/bash
            - -c
            - |
              counter=0
              while [ $counter -lt 30 ]; do
                if /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P "$SA_PASSWORD" -C -Q "SELECT 1" -b -h -1 > /dev/null 2>&1; then
                  echo 'SQL Server is ready!'
                  
                  echo '========================================='
                  echo 'Step 1: Assigning System Admin role in Auth database'
                  echo '========================================='
                  /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P "$SA_PASSWORD" -C -d Konecta_Auth -i /scripts/assign-admin-role.sql
                  
                  echo ''
                  echo '========================================='
                  echo 'Step 2: Setting up admin permissions in UserManagement database'
                  echo '========================================='
                  /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P "$SA_PASSWORD" -C -d Konecta_UserManagement -i /scripts/assign-admin-permissions.sql
                  
                  echo ''
                  echo '========================================='
                  echo 'Admin setup completed successfully!'
                  echo '========================================='
                  exit 0
                fi
                counter=$((counter+1))
                echo "Waiting for SQL Server... (attempt $counter/30)"
                sleep 2
              done
              echo 'SQL Server connection timeout!'
              exit 1
          volumeMounts:
            - name: admin-scripts
              mountPath: /scripts
              readOnly: true
      volumes:
        - name: admin-scripts
          configMap:
            name: sqlserver-admin-setup-scripts
