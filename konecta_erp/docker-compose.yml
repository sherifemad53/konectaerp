services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: Developer
      SA_PASSWORD: 'pa55w0rd!'
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - erp-network
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'pa55w0rd!' -C -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s

  sqlserver-seed:
    image: mcr.microsoft.com/mssql-tools
    container_name: sqlserver-seed
    depends_on:
      sqlserver:
        condition: service_healthy
    environment:
      SA_PASSWORD: 'pa55w0rd!'
    volumes:
      - ./docker/sqlserver:/scripts:ro
    entrypoint: ["/bin/bash", "-c", "counter=0; while [ $$counter -lt 30 ]; do if /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P \"$$SA_PASSWORD\" -C -Q \"SELECT 1\" -b -h -1 > /dev/null 2>&1; then echo 'SQL Server is ready!'; /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P \"$$SA_PASSWORD\" -C -d master -i /scripts/create-databases.sql; exit 0; fi; counter=$$((counter+1)); echo \"Waiting for SQL Server... (attempt $$counter/30)\"; sleep 2; done; echo 'SQL Server connection timeout!'; exit 1"]
    restart: "no"
    networks:
      - erp-network

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - erp-network

  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - erp-network

  consul:
    image: hashicorp/consul:1.18
    container_name: consul
    command: agent -server -bootstrap -ui -client=0.0.0.0
    ports:
      - "8500:8500"
    networks:
      - erp-network

  config-server:
    build:
      context: backend/config
      dockerfile: Dockerfile
    container_name: config-server
    environment:
      SERVER_PORT: 8888
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
      CONSUL_ENDPOINT: http://consul:8500
    depends_on:
      - consul
    ports:
      - "8888:8888"
    networks:
      - erp-network

  api-gateway:
    build:
      context: backend/ApiGateWay
      dockerfile: Dockerfile
    container_name: api-gateway
    environment:
      SPRING_APPLICATION_NAME: api-gateway
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CLOUD_CONFIG_FAILFAST: "true"
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
      CONSUL_SERVICE_HOST: api-gateway
      AUTH_SERVICE_URI: http://authentication-service:7280
      AUTH_JWKS_URI: http://authentication-service:7280/.well-known/jwks.json
      HR_SERVICE_URI: http://hr-service:5005
      USER_MANAGEMENT_SERVICE_URI: http://user-management-service:5078
      INVENTORY_SERVICE_URI: http://inventory-service:5020
      FINANCE_SERVICE_URI: http://finance-service:5003
      REPORTING_SERVICE_URI: http://reporting-service:8085
    depends_on:
      - config-server
      - authentication-service
      - hr-service
      - user-management-service
      - inventory-service
      - finance-service
      - reporting-service
    ports:
      - "8080:8080"
    networks:
      - erp-network

  frontend:
    build:
      context: frontend
      dockerfile: Dockerfile
    container_name: frontend
    depends_on:
      - api-gateway
    ports:
      - "4200:80"
    networks:
      - erp-network

  reporting-service:
    build:
      context: backend/ReportingService
      dockerfile: Dockerfile
    container_name: reporting-service
    environment:
      SPRING_APPLICATION_NAME: reporting-service
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CLOUD_CONFIG_FAILFAST: "true"
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
      CONSUL_SERVICE_HOST: reporting-service
      FINANCE_SERVICE_URI: http://finance-service:5003
      HR_SERVICE_URI: http://hr-service:5005
      INVENTORY_SERVICE_URI: http://inventory-service:5020
    depends_on:
      - config-server
      - finance-service
      - hr-service
      - inventory-service
    ports:
      - "8085:8085"
    networks:
      - erp-network

  authentication-service:
    build:
      context: .
      dockerfile: backend/AuthenticationService/Dockerfile
    container_name: authentication-service
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      SPRING__APPLICATION__NAME: authentication-service
      SPRING__CLOUD__CONFIG__URI: http://config-server:8888
      SPRING__CLOUD__CONFIG__FAILFAST: "true"
      Consul__Host: http://consul:8500
    depends_on:
      sqlserver-seed:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_started
      mailhog:
        condition: service_started
      consul:
        condition: service_started
    ports:
      - "7280:7280"
    networks:
      - erp-network

  hr-service:
    build:
      context: .
      dockerfile: backend/HrService/Dockerfile
    container_name: hr-service
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      SPRING__APPLICATION__NAME: hr-service
      SPRING__CLOUD__CONFIG__URI: http://config-server:8888
      SPRING__CLOUD__CONFIG__FAILFAST: "true"
      Consul__Host: http://consul:8500
    depends_on:
      sqlserver-seed:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_started
      consul:
        condition: service_started
    ports:
      - "5005:5005"
    networks:
      - erp-network

  inventory-service:
    build:
      context: .
      dockerfile: backend/InventoryService/Dockerfile
    container_name: inventory-service
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      SPRING__APPLICATION__NAME: inventory-service
      SPRING__CLOUD__CONFIG__URI: http://config-server:8888
      SPRING__CLOUD__CONFIG__FAILFAST: "true"
      Consul__Host: http://consul:8500
    depends_on:
      sqlserver-seed:
        condition: service_completed_successfully
      consul:
        condition: service_started
    ports:
      - "5020:5020"
    networks:
      - erp-network

  finance-service:
    build:
      context: .
      dockerfile: backend/FinanceService/Dockerfile
    container_name: finance-service
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      SPRING__APPLICATION__NAME: finance-service
      SPRING__CLOUD__CONFIG__URI: http://config-server:8888
      SPRING__CLOUD__CONFIG__FAILFAST: "true"
      Consul__Host: http://consul:8500
    depends_on:
      sqlserver-seed:
        condition: service_completed_successfully
      consul:
        condition: service_started
    ports:
      - "5003:5003"
    networks:
      - erp-network

  user-management-service:
    build:
      context: .
      dockerfile: backend/UserManagementService/Dockerfile
    container_name: user-management-service
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      SPRING__APPLICATION__NAME: user-management-service
      SPRING__CLOUD__CONFIG__URI: http://config-server:8888
      SPRING__CLOUD__CONFIG__FAILFAST: "true"
      Consul__Host: http://consul:8500
    depends_on:
      sqlserver-seed:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_started
      consul:
        condition: service_started
    ports:
      - "5078:5078"
    networks:
      - erp-network

networks:
  erp-network:
    driver: bridge

volumes:
  sqlserver-data:
